name: Build Orb Browser

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-linux:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Build preload and renderer bundles
        run: npm run build-preload

      - name: Build Electron app (AppImage)
        run: npm run app:dist -- --linux AppImage --publish=never

      - name: Archive AppImage
        run: |
          APPIMAGE=$(ls dist/*.AppImage | head -n 1)
          tar -czvf "${APPIMAGE}.tar.gz" "$APPIMAGE"

      - name: Upload AppImage artifact
        uses: actions/upload-artifact@v4
        with:
          name: orb-browser-appimage
          path: dist/*.AppImage.tar.gz

  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Build preload and renderer bundles
        run: npm run build-preload

      - name: Build Electron app (Windows exe)
        run: npm run app:dist -- --win nsis --publish=never

      - name: Archive Windows installer
        run: |
          $exe = Get-ChildItem -Path dist -Filter *.exe | Select-Object -First 1
          Compress-Archive -Path $exe.FullName -DestinationPath "$($exe.FullName).zip"

      - name: Upload Windows installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: orb-browser-windows
          path: dist/*.exe.zip
